<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEWoMan高輪 Bot 比較レポート</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap');

/* ========== Light Analytics Theme ========== */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#F5F7FA;--bg-card:#FFFFFF;--bg-card-hover:#FAFBFC;--bg-elevated:#F0F2F5;
  --border:#E2E8F0;--border-light:#CBD5E1;
  --text:#1A202C;--text-muted:#4A5568;--text-dim:#718096;
  --cyan:#0891B2;--cyan-dim:rgba(8,145,178,0.08);--cyan-glow:rgba(8,145,178,0.18);
  --purple:#7C3AED;--purple-dim:rgba(124,58,237,0.08);--purple-glow:rgba(124,58,237,0.18);
  --green:#059669;--green-dim:rgba(5,150,105,0.08);
  --red:#E11D48;--red-dim:rgba(225,29,72,0.08);
  --orange:#D97706;--orange-dim:rgba(217,119,6,0.08);
  --radius:12px;--radius-lg:16px;
}
body{font-family:'Inter','Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;-webkit-font-smoothing:antialiased}
.container{max-width:1280px;margin:0 auto;padding:32px 20px}
@media(min-width:768px){.container{padding:40px 32px}}

/* Cards */
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;transition:border-color .2s,box-shadow .2s;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
.card:hover{border-color:var(--border-light);box-shadow:0 2px 8px rgba(0,0,0,0.06)}
.card-title{font-size:14px;font-weight:600;color:var(--text-muted);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.card-title svg{width:16px;height:16px;opacity:.5}

/* Header */
.header{margin-bottom:32px}
.header h1{font-size:24px;font-weight:700;letter-spacing:-.02em;margin-bottom:6px}
@media(min-width:768px){.header h1{font-size:28px}}
.header .subtitle{font-size:13px;color:var(--text-dim);margin-bottom:24px}

/* Bot identity cards */
.bot-cards{display:grid;grid-template-columns:1fr;gap:16px;margin-bottom:24px}
@media(min-width:768px){.bot-cards{grid-template-columns:1fr 1fr}}
.bot-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px 24px;position:relative;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
.bot-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.bot-card.bot1::before{background:linear-gradient(90deg,var(--cyan),transparent)}
.bot-card.bot2::before{background:linear-gradient(90deg,var(--purple),transparent)}
.bot-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.bot-label .dot{width:8px;height:8px;border-radius:50%}
.bot1 .bot-label{color:var(--cyan)}.bot1 .dot{background:var(--cyan);box-shadow:0 0 6px var(--cyan-glow)}
.bot2 .bot-label{color:var(--purple)}.bot2 .dot{background:var(--purple);box-shadow:0 0 6px var(--purple-glow)}
.bot-name{font-size:18px;font-weight:700;margin-bottom:8px}
.bot-model-tag{display:inline-block;padding:4px 14px;border-radius:6px;font-size:14px;font-weight:700;letter-spacing:.3px}
.bot1 .bot-model-tag{background:var(--cyan-dim);color:var(--cyan);border:1px solid rgba(8,145,178,0.2)}
.bot2 .bot-model-tag{background:var(--purple-dim);color:var(--purple);border:1px solid rgba(124,58,237,0.2)}
.bot-id{font-family:'SF Mono','Fira Code','Consolas',monospace;font-size:11px;color:var(--text-dim);letter-spacing:.3px;margin-top:8px}

/* Round tabs */
.round-tabs{display:flex;gap:0;margin-bottom:28px;border-bottom:2px solid var(--border);overflow-x:auto;-webkit-overflow-scrolling:touch}
.round-tab{padding:11px 22px;cursor:pointer;font-size:13px;font-weight:600;color:var(--text-dim);border-bottom:3px solid transparent;margin-bottom:-2px;transition:color .2s,border-color .2s;white-space:nowrap;user-select:none}
.round-tab:hover{color:var(--text-muted)}
.round-tab.active{color:var(--cyan);border-bottom-color:var(--cyan)}
.round-tab.tab-overview{font-weight:700}
.round-panel{display:none}.round-panel.active{display:block}

/* Summary box */
.summary-box{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px 28px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
.summary-box .summary-title{font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.summary-box .summary-text{font-size:14px;line-height:1.8;color:var(--text-muted)}
.summary-box .summary-text b{color:var(--text);font-weight:600}
.summary-box .highlight-good{color:var(--green);font-weight:700}
.summary-box .highlight-warn{color:var(--orange);font-weight:700}
.summary-box .highlight-bad{color:var(--red);font-weight:700}
.summary-section{margin-bottom:16px;padding:14px 18px;border-radius:10px;background:var(--bg);border:1px solid var(--border)}
.summary-section:last-child{margin-bottom:0}
.summary-section-head{font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px;display:flex;align-items:center;gap:6px}
.summary-section-head .sec-icon{width:20px;height:20px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;color:#fff;flex-shrink:0}
.summary-section-body{font-size:13px;line-height:1.9;color:var(--text-muted)}
.summary-section-body b{color:var(--text);font-weight:600}
.summary-stat{display:inline-flex;align-items:center;gap:4px;padding:2px 10px;border-radius:5px;font-size:12px;font-weight:700;margin:0 2px}
.stat-cyan{background:var(--cyan-dim);color:var(--cyan)}
.stat-purple{background:var(--purple-dim);color:var(--purple)}
.stat-green{background:var(--green-dim);color:var(--green)}
.stat-orange{background:var(--orange-dim);color:var(--orange)}

/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:28px}
@media(min-width:768px){.kpi-grid{grid-template-columns:repeat(3,1fr);gap:16px}}
@media(min-width:1024px){.kpi-grid{grid-template-columns:repeat(6,1fr);gap:16px}}
.kpi{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
.kpi-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:8px}
.kpi-value{font-size:28px;font-weight:800;letter-spacing:-.02em;line-height:1.1}
@media(min-width:768px){.kpi-value{font-size:34px}}
.kpi-sub{font-size:12px;color:var(--text-dim);margin-top:4px}
.kpi-cyan .kpi-value{color:var(--cyan)}
.kpi-purple .kpi-value{color:var(--purple)}
.kpi-green .kpi-value{color:var(--green)}
.kpi-orange .kpi-value{color:var(--orange)}
.kpi-red .kpi-value{color:var(--red)}

/* Grid layouts */
.grid-2{display:grid;grid-template-columns:1fr;gap:16px;margin-bottom:16px}
@media(min-width:768px){.grid-2{grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}}
.grid-3{display:grid;grid-template-columns:1fr;gap:16px;margin-bottom:16px}
@media(min-width:768px){.grid-3{grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px}}

/* Charts */
.chart-box{width:100%;height:300px}
.chart-box-lg{width:100%;height:360px}

/* Table */
.glass-table{width:100%;border-collapse:collapse;font-size:13px}
.glass-table th{padding:10px 14px;text-align:left;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);border-bottom:1px solid var(--border);background:var(--bg-elevated)}
.glass-table td{padding:10px 14px;border-bottom:1px solid var(--border);color:var(--text-muted)}
.glass-table tr:hover td{background:rgba(0,0,0,.02)}
.glass-table td:first-child{color:var(--text-dim);font-family:'SF Mono',monospace;font-size:12px}

/* Badges */
.badge{display:inline-block;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:600;letter-spacing:.2px}
.badge-answered{background:var(--green-dim);color:var(--green)}
.badge-unanswered{background:var(--red-dim);color:var(--red)}
.badge-cat{background:var(--bg-elevated);color:var(--text-dim);border-radius:4px;font-size:11px;padding:2px 8px}
.winner-cell{background:rgba(5,150,105,.06)}

/* Tabs (question table sub-tabs) */
.tabs{display:flex;gap:2px;margin-bottom:20px;border-bottom:1px solid var(--border)}
.tab{padding:10px 18px;cursor:pointer;font-size:13px;font-weight:500;color:var(--text-dim);border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .2s}
.tab:hover{color:var(--text-muted)}
.tab.active{color:var(--cyan);border-bottom-color:var(--cyan)}
.tab-content{display:none}.tab-content.active{display:block}

/* Filter */
.filter-row{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
.filter-row label{font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px}
.filter-row select,.filter-row input{padding:7px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--bg-elevated);color:var(--text);outline:none;transition:border-color .2s;font-family:inherit}
.filter-row select:focus,.filter-row input:focus{border-color:var(--cyan)}
.filter-row select option{background:var(--bg-card)}
.filter-row input{width:200px}
.filter-row input::placeholder{color:var(--text-dim)}

/* Answer preview */
.answer-preview{max-height:150px;overflow-y:auto;font-size:12px;line-height:1.7;color:var(--text-muted);background:var(--bg);padding:12px 14px;border-radius:8px;margin-top:6px;white-space:pre-wrap;word-break:break-all;border:1px solid var(--border)}
.answer-preview::-webkit-scrollbar{width:4px}
.answer-preview::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:4px}
.answer-toggle{cursor:pointer;color:var(--cyan);font-size:12px;font-weight:500;transition:opacity .2s}
.answer-toggle:hover{opacity:.7}

/* Overview trend styles */
.trend-kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
@media(min-width:768px){.trend-kpi-grid{grid-template-columns:repeat(4,1fr)}}
.status-change-table{width:100%;border-collapse:collapse;font-size:12px}
.status-change-table th{padding:8px 12px;text-align:left;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);border-bottom:1px solid var(--border);background:var(--bg-elevated)}
.status-change-table td{padding:8px 12px;border-bottom:1px solid var(--border);color:var(--text-muted)}
.sc-improved{background:rgba(5,150,105,.06);color:var(--green);font-weight:600}
.sc-regressed{background:rgba(225,29,72,.06);color:var(--red);font-weight:600}

/* Footer */
.footer{text-align:center;padding:24px 0 16px;font-size:11px;color:var(--text-dim)}

/* Scrollbar */
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px}

/* Animations */
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.animate-in{animation:fadeUp .4s ease both}
.animate-in:nth-child(1){animation-delay:0s}
.animate-in:nth-child(2){animation-delay:.06s}
.animate-in:nth-child(3){animation-delay:.12s}
.animate-in:nth-child(4){animation-delay:.18s}
@media(prefers-reduced-motion:reduce){.animate-in{animation:none}}
</style>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
<div class="container">

  <!-- ===== HEADER ===== -->
  <div class="header">
    <h1>NEWoMan高輪 Bot 比較レポート</h1>
    <p class="subtitle" id="report-subtitle"></p>
  </div>

  <!-- ===== BOT IDENTITY ===== -->
  <div class="bot-cards">
    <div class="bot-card bot1 animate-in">
      <div class="bot-label"><span class="dot"></span>Bot 1 &mdash; 検証環境</div>
      <div class="bot-name">NEWoMan高輪 検証環境</div>
      <div class="bot-model-tag">Claude Sonnet 4.5</div>
      <div class="bot-id">ID: fa228b57-59e1-447b-87e2-02c494195961</div>
    </div>
    <div class="bot-card bot2 animate-in">
      <div class="bot-label"><span class="dot"></span>Bot 2 &mdash; 本番環境</div>
      <div class="bot-name">NEWoMan高輪 本番環境</div>
      <div class="bot-model-tag">Gemini 2.5 Flash</div>
      <div class="bot-id">ID: b50d5b21-262a-4802-a8c4-512af224c72f</div>
    </div>
  </div>

  <!-- ===== ROUND TABS (generated by JS when multi-round) ===== -->
  <div id="round-tabs" class="round-tabs" style="display:none"></div>

  <!-- ===== PANELS CONTAINER ===== -->
  <div id="panels"></div>

  <div class="footer">Generated by newoman-eval</div>
</div>

<script>
const BOT1_SHORT='検証環境',BOT2_SHORT='本番環境';
const BOT1_MODEL='Sonnet 4.5',BOT2_MODEL='Gemini 2.5 Flash';
const C1='#0891B2',C1L='#22D3EE',C2='#7C3AED',C2L='#A78BFA';
const TX='#718096',LN='#E2E8F0';

let ROUNDS=[];
const chartInstances=[];
const renderedPanels=new Set();

async function loadData(){
  try{
    const[r1,r2]=await Promise.all([
      fetch('eval-fa228b57-20260220-182201.json'),
      fetch('eval-b50d5b21-20260220-212710.json')
    ]);
    if(r1.ok&&r2.ok){
      const b1=await r1.json(),b2=await r2.json();
      ROUNDS=[{label:'第1回',date:b1.meta.timestamp.slice(0,10),bot1:b1,bot2:b2}];
      return true;
    }
  }catch(e){}
  return false;
}

function init(){
  const isMulti=ROUNDS.length>1;
  // Subtitle
  if(isMulti){
    const dates=ROUNDS.map(r=>r.date).join(', ');
    document.getElementById('report-subtitle').textContent=
      `テスト回数: ${ROUNDS.length}回 \u2502 質問数: ${ROUNDS[0].bot1.meta.total_questions} \u2502 テスト日: ${dates}`;
  }else{
    const r=ROUNDS[0];
    document.getElementById('report-subtitle').textContent=
      `テスト日: ${r.date} \u2502 質問数: ${r.bot1.meta.total_questions}`;
  }

  // Build tab bar
  if(isMulti){
    const tabBar=document.getElementById('round-tabs');
    tabBar.style.display='flex';
    let html='<div class="round-tab tab-overview active" data-panel="overview">総合</div>';
    ROUNDS.forEach((r,i)=>{
      html+=`<div class="round-tab" data-panel="round-${i}">${r.label} (${r.date})</div>`;
    });
    tabBar.innerHTML=html;
    tabBar.querySelectorAll('.round-tab').forEach(tab=>{
      tab.addEventListener('click',()=>switchPanel(tab.dataset.panel));
    });
  }

  // Create panel containers
  const panels=document.getElementById('panels');
  if(isMulti){
    panels.innerHTML='<div id="panel-overview" class="round-panel active"></div>';
    ROUNDS.forEach((r,i)=>{
      panels.innerHTML+=`<div id="panel-round-${i}" class="round-panel"></div>`;
    });
    renderOverview();
    renderedPanels.add('overview');
  }else{
    panels.innerHTML='<div id="panel-round-0" class="round-panel active"></div>';
    renderRound(0);
    renderedPanels.add('round-0');
  }
}

function switchPanel(panelId){
  document.querySelectorAll('.round-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.round-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('panel-'+panelId).classList.add('active');
  document.querySelector(`.round-tab[data-panel="${panelId}"]`).classList.add('active');
  // Lazy render
  if(!renderedPanels.has(panelId)){
    if(panelId==='overview') renderOverview();
    else{
      const idx=parseInt(panelId.replace('round-',''));
      renderRound(idx);
    }
    renderedPanels.add(panelId);
  }
  // Resize charts
  setTimeout(()=>chartInstances.forEach(c=>{try{c.resize()}catch(e){}}),120);
}

// ============================================================
// ROUND RENDERING - renders a full single-round report
// ============================================================
function renderRound(idx){
  const r=ROUNDS[idx],b1=r.bot1,b2=r.bot2,s=`-${idx}`;
  const panel=document.getElementById('panel-round-'+idx);
  panel.innerHTML=buildRoundHTML(idx);
  renderSummary(b1,b2,s);
  renderRagAnalysis(b1,b2,s);
  renderCategoryChart(b1,b2,s);
  renderSourceChart(b1.summary,b2.summary,s);
  renderTimeChart(b1,b2,s);
  renderTable(b1,b2,s);
  setupFilters(b1,b2,s);
}

function buildRoundHTML(idx){
  const s=`-${idx}`;
  return `
  <div class="summary-box animate-in" id="exec-summary${s}"></div>
  <div class="card" style="margin-bottom:20px">
    <div class="card-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/></svg>
      回答処理の分析
    </div>
    <p style="font-size:12px;color:var(--text-dim);margin:-8px 0 16px;line-height:1.6">
      <b style="color:var(--green)">正常処理</b> = 回答を返した + 該当情報なし&emsp;
      <b style="color:var(--red)">処理失敗</b> = 応答なし + 定型文のみ + エラー
    </p>
    <div class="kpi-grid" id="rag-kpi-row${s}" style="margin-bottom:20px"></div>
    <div class="grid-2" style="margin-bottom:0">
      <div><div class="chart-box" id="chart-rag-exec${s}"></div></div>
      <div><div class="chart-box" id="chart-rag-fail-detail${s}"></div></div>
    </div>
  </div>
  <div class="grid-2">
    <div class="card">
      <div class="card-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        カテゴリ別の正常回答率
      </div>
      <div class="chart-box-lg" id="chart-category${s}"></div>
    </div>
    <div class="card">
      <div class="card-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 1 0 20"/><path d="M2 12h20"/></svg>
        回答ソースの内訳 (RAG / FAQ)
      </div>
      <div class="chart-box-lg" id="chart-source${s}"></div>
    </div>
  </div>
  <div class="card" style="margin-bottom:20px">
    <div class="card-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      平均応答時間（秒）
    </div>
    <div class="kpi-grid" id="time-kpi-row${s}" style="margin-bottom:20px;grid-template-columns:repeat(3,1fr)"></div>
    <div class="chart-box" id="chart-time${s}"></div>
  </div>
  <div class="card" style="margin-bottom:20px">
    <div class="card-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
      全質問の一覧 (<span id="visible-count${s}">0</span> / ${ROUNDS[idx].bot1.results.length})
    </div>
    <div class="filter-row">
      <label>カテゴリ:</label>
      <select id="filter-cat${s}"><option value="">すべて</option></select>
      <label>処理結果:</label>
      <select id="filter-result${s}">
        <option value="">すべて</option>
        <option value="both-ok">両方とも正常</option>
        <option value="both-fail">両方とも失敗</option>
        <option value="bot1-ok-only">検証のみ正常</option>
        <option value="bot2-ok-only">本番のみ正常</option>
        <option value="any-fail">失敗あり</option>
      </select>
      <label>検索:</label>
      <input type="text" id="filter-search${s}" placeholder="質問を検索...">
    </div>
    <div style="overflow-x:auto">
      <table class="glass-table">
        <thead><tr>
          <th>#</th><th>カテゴリ</th><th>質問</th>
          <th>検証環境<br><span style="font-weight:400;opacity:.6">Sonnet 4.5</span></th>
          <th>本番環境<br><span style="font-weight:400;opacity:.6">Gemini 2.5 Flash</span></th>
          <th>詳細</th>
        </tr></thead>
        <tbody id="tbody-all${s}"></tbody>
      </table>
    </div>
  </div>`;
}

// ============================================================
// CHART + RENDER HELPERS
// ============================================================
function tipStyle(){return{backgroundColor:'#FFFFFF',borderColor:'#E2E8F0',textStyle:{color:'#1A202C',fontSize:12},extraCssText:'box-shadow:0 4px 12px rgba(0,0,0,0.1)'}}
function barGrad(c1,c2){return new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:c1},{offset:1,color:c2}])}
function initChart(id){const el=document.getElementById(id);if(!el)return null;const c=echarts.init(el);chartInstances.push(c);return c}

const FAIL_REASONS=['empty','filler_only','error'];
function calcRag(bot){
  const t=bot.results.length;
  const fail=bot.results.filter(r=>FAIL_REASONS.includes(r.reason)).length;
  const ok=t-fail;
  const ans=bot.results.filter(r=>r.reason==='answered').length;
  const nf=bot.results.filter(r=>r.reason==='not_found').length;
  return{total:t,ok,fail,rate:+(ok/t*100).toFixed(1),answered:ans,not_found:nf,
    empty:bot.results.filter(r=>r.reason==='empty').length,
    filler:bot.results.filter(r=>r.reason==='filler_only').length,
    err:bot.results.filter(r=>r.reason==='error').length};
}
function avgTime(results){if(!results.length)return 0;return+(results.reduce((s,r)=>s+r.elapsed_seconds,0)/results.length).toFixed(1)}
function maxCatAvg(bot){
  const cats={};
  bot.results.forEach(r=>{if(!cats[r.category])cats[r.category]=[];cats[r.category].push(r.elapsed_seconds)});
  let mx=0;
  for(const c in cats){const a=+(cats[c].reduce((s,v)=>s+v,0)/cats[c].length).toFixed(1);if(a>mx)mx=a}
  return mx;
}
function escHtml(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function isRagFail(r){return FAIL_REASONS.includes(r.reason)}
function statusBadge(r){
  if(!isRagFail(r)){
    if(r.reason==='not_found') return '<span class="badge badge-answered" style="background:var(--orange-dim);color:var(--orange)">該当なし</span>';
    const src=r.source==='faq'?' FAQ':'';
    return '<span class="badge badge-answered">回答'+src+'</span>';
  }
  const lb={empty:'応答なし',error:'エラー',filler_only:'定型文'};
  return '<span class="badge badge-unanswered">'+(lb[r.reason]||r.reason)+'</span>';
}

// ============================================================
// EXECUTIVE SUMMARY
// ============================================================
function renderSummary(b1,b2,s){
  const r1=calcRag(b1),r2=calcRag(b2);
  const t1=avgTime(b1.results),t2=avgTime(b2.results);
  const catMax1=maxCatAvg(b1),catMax2=maxCatAvg(b2);
  const faq1=b1.results.filter(r=>r.source==='faq'),faq2=b2.results.filter(r=>r.source==='faq');
  const faqAvg1=faq1.length?+(faq1.reduce((a,r)=>a+r.elapsed_seconds,0)/faq1.length).toFixed(1):0;
  const faqAvg2=faq2.length?+(faq2.reduce((a,r)=>a+r.elapsed_seconds,0)/faq2.length).toFixed(1):0;
  const testDate=b1.meta.timestamp.slice(0,10);
  const timeDiff=(t1-t2).toFixed(1);
  const catDiff=(catMax2-catMax1).toFixed(1);
  const el=document.getElementById('exec-summary'+s);
  el.innerHTML=`
    <div class="summary-title">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></svg>
      テスト結果の概要
    </div>
    <div class="summary-section">
      <div class="summary-section-head"><span class="sec-icon" style="background:#64748B">1</span>テストの背景</div>
      <div class="summary-section-body">
        現在本番環境で稼働中の <span class="summary-stat stat-purple">${BOT2_MODEL}</span> から
        <span class="summary-stat stat-cyan">${BOT1_MODEL}</span> への切り替えを検討するにあたり、
        ${testDate} に同一条件での比較テストを実施しました。<br>
        テスト対象は<b>${BOT1_SHORT}（${BOT1_MODEL}）</b>と<b>${BOT2_SHORT}（${BOT2_MODEL}）</b>の2環境で、
        営業時間・アクセス・店舗情報・イベント・施設案内など実際の利用シーンを想定した
        <b>${b1.meta.total_questions}件</b>の質問を、両環境に同一条件で送信しています。
      </div>
    </div>
    <div class="summary-section">
      <div class="summary-section-head"><span class="sec-icon" style="background:var(--green)">2</span>検証①：回答の安定性に差はあるか</div>
      <div class="summary-section-body">
        RAGパイプライン（情報検索→回答生成）が正常に完了した割合を比較します。<br>
        <span class="summary-stat stat-cyan">${BOT1_MODEL}: ${r1.rate}%</span>（${r1.ok}件正常 / ${r1.total}件中）<br>
        <span class="summary-stat stat-purple">${BOT2_MODEL}: ${r2.rate}%</span>（${r2.ok}件正常 / ${r2.total}件中）<br>
        処理失敗（応答なし・定型文のみ・エラー）の内訳は、
        ${BOT1_MODEL} が <b>${r1.fail}件</b>（応答なし: ${r1.empty}、定型文: ${r1.filler}、エラー: ${r1.err}）、
        ${BOT2_MODEL} が <b>${r2.fail}件</b>（応答なし: ${r2.empty}、定型文: ${r2.filler}、エラー: ${r2.err}）です。<br>
        また、有効な回答を返せた件数は ${BOT1_MODEL} が <b>${r1.answered}件</b>、${BOT2_MODEL} が <b>${r2.answered}件</b> で、
        <b>${Math.abs(r1.answered-r2.answered)}件の差</b>が見られます。<br>
        以上のデータから、${BOT1_MODEL} はRAGパイプラインの処理完了率・回答件数ともに ${BOT2_MODEL} を上回っており、
        <b>回答の安定性は ${BOT1_MODEL} の方が高い</b>と判断できます。
      </div>
    </div>
    <div class="summary-section">
      <div class="summary-section-head"><span class="sec-icon" style="background:var(--cyan)">3</span>検証②：応答速度に差はあるか</div>
      <div class="summary-section-body">
        全体の平均応答時間を比較します。<br>
        <span class="summary-stat stat-cyan">${BOT1_MODEL}: ${t1}秒</span>
        <span class="summary-stat stat-purple">${BOT2_MODEL}: ${t2}秒</span><br>
        全体平均では ${BOT1_MODEL} が約 <b>${Math.abs(parseFloat(timeDiff))}秒${parseFloat(timeDiff)>0?'遅い':'速い'}</b> 結果です。
        ただし、この数値はバックエンドのRAG情報検索を含む<b>エンドツーエンドの処理時間</b>であり、
        実際のユーザー体感とは異なります。<br>
        <b>FAQ経由の回答</b>（よくある質問への即答）に限ると、
        ${BOT1_MODEL}: 平均 <b>${faqAvg1}秒</b> / ${BOT2_MODEL}: 平均 <b>${faqAvg2}秒</b> と、
        いずれも1秒未満で処理されており、体感上の差はありません。<br>
        また、カテゴリ別の最大平均応答時間では
        <span class="summary-stat stat-cyan">${BOT1_MODEL}: ${catMax1}秒</span>
        <span class="summary-stat stat-purple">${BOT2_MODEL}: ${catMax2}秒</span>と、
        ${BOT2_MODEL} の方が <b>${catDiff}秒長く</b>なっています。<br>
        以上を総合すると、全体平均では ${BOT1_MODEL} が約${Math.abs(parseFloat(timeDiff)).toFixed(0)}秒遅いものの、
        FAQ即答の速さやカテゴリ別ピークの安定性を考慮すると、
        <b>ユーザー体験に大きな影響を与える差ではない</b>と考えられます。
      </div>
    </div>`;
}

// ============================================================
// RAG ANALYSIS
// ============================================================
function renderRagAnalysis(b1,b2,s){
  const r1=calcRag(b1),r2=calcRag(b2);
  const diff=(r1.rate-r2.rate).toFixed(1);
  const t1=avgTime(b1.results),t2=avgTime(b2.results);
  const kpiRow=document.getElementById('rag-kpi-row'+s);
  const kpis=[
    {label:BOT1_SHORT+' 正常回答率',value:r1.rate+'%',sub:r1.ok+' / '+r1.total+' 正常',cls:'kpi-cyan'},
    {label:BOT2_SHORT+' 正常回答率',value:r2.rate+'%',sub:r2.ok+' / '+r2.total+' 正常',cls:'kpi-purple'},
    {label:'回答率の差',value:(diff>0?'+':'')+diff+'%',sub:'検証 − 本番',cls:parseFloat(diff)>=0?'kpi-green':'kpi-red'},
    {label:'失敗数の差',value:Math.abs(r1.fail-r2.fail),sub:'検証'+r1.fail+'件 / 本番'+r2.fail+'件',cls:'kpi-orange'},
    {label:BOT1_SHORT+' 平均応答',value:t1+'s',sub:'全質問平均',cls:'kpi-cyan'},
    {label:BOT2_SHORT+' 平均応答',value:t2+'s',sub:'全質問平均',cls:'kpi-purple'},
  ];
  kpiRow.innerHTML=kpis.map((k,i)=>
    '<div class="kpi '+k.cls+' animate-in" style="animation-delay:'+i*.06+'s">'+
    '<div class="kpi-label">'+k.label+'</div>'+
    '<div class="kpi-value">'+k.value+'</div>'+
    '<div class="kpi-sub">'+k.sub+'</div></div>').join('');

  const c1=initChart('chart-rag-exec'+s);
  if(c1)c1.setOption({
    tooltip:{trigger:'axis',...tipStyle(),formatter:function(p){
      var x=p[0].axisValue+'<br>';
      p.forEach(function(v){x+='<span style="color:'+v.color+'">\u25CF</span> '+v.seriesName+': '+v.value+'件<br>'});
      return x;
    }},
    legend:{bottom:0,textStyle:{color:TX}},
    grid:{top:30,bottom:50,left:50,right:20},
    xAxis:{type:'category',data:[BOT1_SHORT+'\n('+BOT1_MODEL+')',BOT2_SHORT+'\n('+BOT2_MODEL+')'],axisLine:{lineStyle:{color:LN}},axisLabel:{color:TX,fontWeight:600}},
    yAxis:{type:'value',max:r1.total,splitLine:{lineStyle:{color:LN}},axisLabel:{color:TX}},
    series:[
      {name:'正常処理',type:'bar',stack:'a',data:[r1.ok,r2.ok],itemStyle:{color:'#059669',borderRadius:[0,0,0,0]},barWidth:'40%',label:{show:true,position:'inside',color:'#fff',fontWeight:600,fontSize:13}},
      {name:'処理失敗',type:'bar',stack:'a',data:[r1.fail,r2.fail],itemStyle:{color:'#E11D48',borderRadius:[6,6,0,0]},barWidth:'40%',label:{show:true,position:'inside',color:'#fff',fontWeight:600,fontSize:13,formatter:function(p){return p.value>0?p.value:''}}},
    ]
  });

  const c2=initChart('chart-rag-fail-detail'+s);
  if(c2)c2.setOption({
    tooltip:{trigger:'axis',...tipStyle()},
    legend:{bottom:0,textStyle:{color:TX}},
    grid:{top:30,bottom:50,left:50,right:20},
    xAxis:{type:'category',data:['応答なし','定型文のみ','エラー'],axisLine:{lineStyle:{color:LN}},axisLabel:{color:TX}},
    yAxis:{type:'value',splitLine:{lineStyle:{color:LN}},axisLabel:{color:TX}},
    series:[
      {name:BOT1_SHORT+'('+BOT1_MODEL+')',type:'bar',data:[r1.empty,r1.filler,r1.err],itemStyle:{color:barGrad(C1,C1L),borderRadius:[6,6,0,0]},barWidth:'26%',label:{show:true,position:'top',color:C1,fontWeight:600}},
      {name:BOT2_SHORT+'('+BOT2_MODEL+')',type:'bar',data:[r2.empty,r2.filler,r2.err],itemStyle:{color:barGrad(C2,C2L),borderRadius:[6,6,0,0]},barWidth:'26%',label:{show:true,position:'top',color:C2,fontWeight:600}},
    ]
  });
}

// ============================================================
// CATEGORY CHART
// ============================================================
function renderCategoryChart(b1,b2,s){
  const c=initChart('chart-category'+s);
  if(!c)return;
  const cats=[...new Set(b1.results.map(r=>r.category))].sort();
  function ragRate(results,cat){
    const items=results.filter(r=>r.category===cat);
    if(!items.length)return 0;
    const ok=items.filter(r=>!FAIL_REASONS.includes(r.reason)).length;
    return +(ok/items.length*100).toFixed(1);
  }
  c.setOption({
    tooltip:{trigger:'axis',...tipStyle(),formatter:function(p){return p.map(function(x){return '<span style="color:'+x.color+'">\u25CF</span> '+x.seriesName+': '+x.value+'%'}).join('<br>')}},
    legend:{bottom:0,textStyle:{color:TX}},
    grid:{left:80,top:10,bottom:50,right:60},
    yAxis:{type:'category',data:cats,axisLine:{lineStyle:{color:LN}},axisLabel:{color:TX}},
    xAxis:{type:'value',max:100,axisLabel:{formatter:'{value}%',color:TX},splitLine:{lineStyle:{color:LN}}},
    series:[
      {name:BOT1_SHORT+'('+BOT1_MODEL+')',type:'bar',data:cats.map(function(c){return ragRate(b1.results,c)}),itemStyle:{color:C1,borderRadius:[0,4,4,0]},label:{show:true,position:'right',formatter:'{c}%',color:C1,fontSize:11}},
      {name:BOT2_SHORT+'('+BOT2_MODEL+')',type:'bar',data:cats.map(function(c){return ragRate(b2.results,c)}),itemStyle:{color:C2,borderRadius:[0,4,4,0]},label:{show:true,position:'right',formatter:'{c}%',color:C2,fontSize:11}},
    ]
  });
}

// ============================================================
// SOURCE CHART
// ============================================================
function renderSourceChart(s1,s2,s){
  const c=initChart('chart-source'+s);
  if(!c)return;
  const ss1=s1.source_stats||{},ss2=s2.source_stats||{};
  c.setOption({
    tooltip:{trigger:'item',...tipStyle()},
    series:[
      {name:BOT1_SHORT+'('+BOT1_MODEL+')',type:'pie',radius:['30%','52%'],center:['28%','55%'],
        data:[{name:'RAG',value:ss1.rag||0,itemStyle:{color:C1}},{name:'FAQ',value:ss1.faq||0,itemStyle:{color:C1L}}],
        label:{formatter:'{b}\n{c}件 ({d}%)',color:TX,fontSize:11,lineHeight:16},labelLine:{length:12,length2:8},
        emphasis:{itemStyle:{shadowBlur:12,shadowColor:'rgba(8,145,178,0.15)'}}},
      {name:BOT2_SHORT+'('+BOT2_MODEL+')',type:'pie',radius:['30%','52%'],center:['72%','55%'],
        data:[{name:'RAG',value:ss2.rag||0,itemStyle:{color:C2}},{name:'FAQ',value:ss2.faq||0,itemStyle:{color:C2L}}],
        label:{formatter:'{b}\n{c}件 ({d}%)',color:TX,fontSize:11,lineHeight:16},labelLine:{length:12,length2:8},
        emphasis:{itemStyle:{shadowBlur:12,shadowColor:'rgba(124,58,237,0.15)'}}},
    ],
    title:[
      {text:BOT1_SHORT+'\n('+BOT1_MODEL+')',left:'28%',top:'8%',textStyle:{fontSize:12,color:C1,fontWeight:600,lineHeight:16},textAlign:'center'},
      {text:BOT2_SHORT+'\n('+BOT2_MODEL+')',left:'72%',top:'8%',textStyle:{fontSize:12,color:C2,fontWeight:600,lineHeight:16},textAlign:'center'},
    ]
  });
}

// ============================================================
// TIME CHART
// ============================================================
function renderTimeChart(b1,b2,s){
  const avg1=avgTime(b1.results),avg2=avgTime(b2.results);
  const timeDiff=(avg1-avg2).toFixed(1);
  const tkpi=document.getElementById('time-kpi-row'+s);
  const tkpis=[
    {label:BOT1_SHORT+' ('+BOT1_MODEL+')',value:avg1+'s',sub:b1.results.length+'件の平均',cls:'kpi-cyan'},
    {label:BOT2_SHORT+' ('+BOT2_MODEL+')',value:avg2+'s',sub:b2.results.length+'件の平均',cls:'kpi-purple'},
    {label:'差分',value:(timeDiff>0?'+':'')+timeDiff+'s',sub:'検証 − 本番',cls:parseFloat(timeDiff)<=0?'kpi-green':'kpi-red'},
  ];
  tkpi.innerHTML=tkpis.map(function(k,i){return '<div class="kpi '+k.cls+' animate-in" style="animation-delay:'+i*.06+'s"><div class="kpi-label">'+k.label+'</div><div class="kpi-value">'+k.value+'</div><div class="kpi-sub">'+k.sub+'</div></div>'}).join('');

  const c=initChart('chart-time'+s);
  if(!c)return;
  const cats=[...new Set(b1.results.map(r=>r.category))].sort();
  function avg(results,cat){var it=results.filter(r=>r.category===cat);if(!it.length)return 0;return+(it.reduce((a,r)=>a+r.elapsed_seconds,0)/it.length).toFixed(1)}
  c.setOption({
    tooltip:{trigger:'axis',...tipStyle()},
    legend:{bottom:0,textStyle:{color:TX}},
    grid:{top:20,bottom:50,left:50,right:20},
    xAxis:{type:'category',data:cats,axisLine:{lineStyle:{color:LN}},axisLabel:{color:TX,fontSize:11}},
    yAxis:{type:'value',name:'秒',nameTextStyle:{color:TX},splitLine:{lineStyle:{color:LN}},axisLabel:{color:TX}},
    series:[
      {name:BOT1_SHORT+'('+BOT1_MODEL+')',type:'bar',data:cats.map(function(c){return avg(b1.results,c)}),itemStyle:{color:barGrad(C1,C1L),borderRadius:[6,6,0,0]},barWidth:'26%',label:{show:true,position:'top',formatter:'{c}s',color:C1,fontSize:10}},
      {name:BOT2_SHORT+'('+BOT2_MODEL+')',type:'bar',data:cats.map(function(c){return avg(b2.results,c)}),itemStyle:{color:barGrad(C2,C2L),borderRadius:[6,6,0,0]},barWidth:'26%',label:{show:true,position:'top',formatter:'{c}s',color:C2,fontSize:10}},
    ]
  });
}

// ============================================================
// TABLE
// ============================================================
function renderTable(b1,b2,s){
  var rows=[];
  for(var i=0;i<b1.results.length;i++){
    var r1=b1.results[i],r2=b2.results[i];
    var f1=isRagFail(r1),f2=isRagFail(r2);
    rows.push({r1:r1,r2:r2,f1:f1,f2:f2,isDiff:f1!==f2,index:r1.index,category:r1.category,question:r1.question});
  }
  var uid=s.replace('-','');
  document.getElementById('tbody-all'+s).innerHTML=rows.map(function(row){
    var w1=row.isDiff&&!row.f1?' winner-cell':'';
    var w2=row.isDiff&&!row.f2?' winner-cell':'';
    return '<tr data-cat="'+row.category+'" data-f1="'+(row.f1?1:0)+'" data-f2="'+(row.f2?1:0)+'" data-q="'+row.question.toLowerCase()+'">'+
      '<td>'+row.index+'</td>'+
      '<td><span class="badge-cat">'+row.category+'</span></td>'+
      '<td style="max-width:320px;color:var(--text)">'+escHtml(row.question)+'</td>'+
      '<td class="'+w1+'">'+statusBadge(row.r1)+'</td>'+
      '<td class="'+w2+'">'+statusBadge(row.r2)+'</td>'+
      '<td><span class="answer-toggle" onclick="toggleAnswer(this,\'ans'+uid+'-'+(row.index-1)+'\')">展開</span></td>'+
      '</tr>'+
      '<tr class="answer-row" id="ans'+uid+'-'+(row.index-1)+'" style="display:none">'+
      '<td colspan="6" style="padding:12px 14px"><div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">'+
      '<div><div style="font-size:12px;font-weight:600;color:'+C1+';margin-bottom:4px;display:flex;align-items:center;gap:6px">'+
      '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:'+C1+'"></span>'+BOT1_SHORT+' ('+BOT1_MODEL+')</div>'+
      '<div class="answer-preview">'+escHtml(row.r1.answer||'(応答なし)')+'</div></div>'+
      '<div><div style="font-size:12px;font-weight:600;color:'+C2+';margin-bottom:4px;display:flex;align-items:center;gap:6px">'+
      '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:'+C2+'"></span>'+BOT2_SHORT+' ('+BOT2_MODEL+')</div>'+
      '<div class="answer-preview">'+escHtml(row.r2.answer||'(応答なし)')+'</div></div>'+
      '</div></td></tr>';
  }).join('');
  document.getElementById('visible-count'+s).textContent=rows.length;
}

function toggleAnswer(el,id){
  var row=document.getElementById(id);
  if(!row)return;
  if(row.style.display==='none'){row.style.display='';el.textContent='閉じる'}
  else{row.style.display='none';el.textContent='展開'}
}

function setupFilters(b1,b2,s){
  var cats=[...new Set(b1.results.map(r=>r.category))].sort();
  var cs=document.getElementById('filter-cat'+s);
  cats.forEach(function(c){var o=document.createElement('option');o.value=c;o.textContent=c;cs.appendChild(o)});
  ['filter-cat'+s,'filter-result'+s,'filter-search'+s].forEach(function(id){
    document.getElementById(id).addEventListener(id.includes('search')?'input':'change',function(){applyFilters(s)});
  });
}

function applyFilters(s){
  var cat=document.getElementById('filter-cat'+s).value;
  var result=document.getElementById('filter-result'+s).value;
  var search=document.getElementById('filter-search'+s).value.toLowerCase();
  var count=0;
  document.querySelectorAll('#tbody-all'+s+' tr').forEach(function(tr){
    if(tr.classList.contains('answer-row'))return;
    var trCat=tr.dataset.cat,trQ=tr.dataset.q||'';
    var f1=tr.dataset.f1==='1',f2=tr.dataset.f2==='1';
    var show=true;
    if(cat&&trCat!==cat)show=false;
    if(search&&!trQ.includes(search))show=false;
    if(result){
      if(result==='both-ok'&&(f1||f2))show=false;
      if(result==='both-fail'&&(!f1||!f2))show=false;
      if(result==='bot1-ok-only'&&(f1||!f2))show=false;
      if(result==='bot2-ok-only'&&(!f1||f2))show=false;
      if(result==='any-fail'&&!f1&&!f2)show=false;
    }
    tr.style.display=show?'':'none';
    if(show)count++;
    var ans=tr.nextElementSibling;
    if(ans&&ans.classList.contains('answer-row')&&!show)ans.style.display='none';
  });
  document.getElementById('visible-count'+s).textContent=count;
}

// ============================================================
// OVERVIEW PANEL (multi-round trends)
// ============================================================
function renderOverview(){
  var panel=document.getElementById('panel-overview');
  panel.innerHTML=buildOverviewHTML();
  renderOverviewSummary();
  renderTrendRateChart();
  renderTrendTimeChart();
  renderTrendCategoryChart();
  renderStatusChanges();
}

function buildOverviewHTML(){
  return `
  <div class="summary-box" id="overview-summary"></div>
  <div class="grid-2">
    <div class="card">
      <div class="card-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        各回の正常回答率の推移
      </div>
      <div class="chart-box" id="chart-trend-rate"></div>
    </div>
    <div class="card">
      <div class="card-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        各回の平均応答時間の推移
      </div>
      <div class="chart-box" id="chart-trend-time"></div>
    </div>
  </div>
  <div class="card" style="margin-bottom:20px">
    <div class="card-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      カテゴリ別の正常回答率 - 全回比較
    </div>
    <div class="chart-box-lg" id="chart-trend-category" style="height:400px"></div>
  </div>
  <div class="card" style="margin-bottom:20px">
    <div class="card-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
      回答ステータスの変化（改善 / 悪化）
    </div>
    <div id="status-changes" style="overflow-x:auto"></div>
  </div>`;
}

function renderOverviewSummary(){
  var el=document.getElementById('overview-summary');
  var lines=[];
  lines.push('<div class="summary-title"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>全回テスト総合サマリー</div>');
  lines.push('<div class="summary-section"><div class="summary-section-body">');
  lines.push(ROUNDS.length+'回のテストを通じた結果の推移です。<br>');
  ROUNDS.forEach(function(r,i){
    var c1=calcRag(r.bot1),c2=calcRag(r.bot2);
    var t1=avgTime(r.bot1.results),t2=avgTime(r.bot2.results);
    lines.push('<b>'+r.label+' ('+r.date+')</b>: '+BOT1_MODEL+' 正常回答率 <span class="summary-stat stat-cyan">'+c1.rate+'%</span> / '+BOT2_MODEL+' <span class="summary-stat stat-purple">'+c2.rate+'%</span>、平均応答 '+t1+'s / '+t2+'s<br>');
  });
  // Compare first and last round
  var first=ROUNDS[0],last=ROUNDS[ROUNDS.length-1];
  var fc1=calcRag(first.bot1),lc1=calcRag(last.bot1);
  var fc2=calcRag(first.bot2),lc2=calcRag(last.bot2);
  if(ROUNDS.length>1){
    lines.push('<br>');
    var d1=(lc1.rate-fc1.rate).toFixed(1),d2=(lc2.rate-fc2.rate).toFixed(1);
    lines.push(first.label+'→'+last.label+'の変化: '+BOT1_MODEL+' <b>'+(d1>0?'+':'')+d1+'%</b>、'+BOT2_MODEL+' <b>'+(d2>0?'+':'')+d2+'%</b>');
  }
  lines.push('</div></div>');
  el.innerHTML=lines.join('');
}

function renderTrendRateChart(){
  var c=initChart('chart-trend-rate');
  if(!c)return;
  var labels=ROUNDS.map(function(r){return r.label+'\n('+r.date+')'});
  var d1=ROUNDS.map(function(r){return calcRag(r.bot1).rate});
  var d2=ROUNDS.map(function(r){return calcRag(r.bot2).rate});
  c.setOption({
    tooltip:{trigger:'axis',...tipStyle()},
    legend:{bottom:0,textStyle:{color:TX}},
    grid:{top:20,bottom:50,left:50,right:30},
    xAxis:{type:'category',data:labels,axisLine:{lineStyle:{color:LN}},axisLabel:{color:TX,fontSize:11}},
    yAxis:{type:'value',min:function(v){return Math.floor(v.min-2)},max:100,axisLabel:{formatter:'{value}%',color:TX},splitLine:{lineStyle:{color:LN}}},
    series:[
      {name:BOT1_SHORT+'('+BOT1_MODEL+')',type:'line',data:d1,lineStyle:{color:C1,width:3},itemStyle:{color:C1},symbol:'circle',symbolSize:10,
        label:{show:true,formatter:'{c}%',color:C1,fontSize:12,fontWeight:600,position:'top'}},
      {name:BOT2_SHORT+'('+BOT2_MODEL+')',type:'line',data:d2,lineStyle:{color:C2,width:3},itemStyle:{color:C2},symbol:'circle',symbolSize:10,
        label:{show:true,formatter:'{c}%',color:C2,fontSize:12,fontWeight:600,position:'bottom'}},
    ]
  });
}

function renderTrendTimeChart(){
  var c=initChart('chart-trend-time');
  if(!c)return;
  var labels=ROUNDS.map(function(r){return r.label+'\n('+r.date+')'});
  var d1=ROUNDS.map(function(r){return avgTime(r.bot1.results)});
  var d2=ROUNDS.map(function(r){return avgTime(r.bot2.results)});
  c.setOption({
    tooltip:{trigger:'axis',...tipStyle()},
    legend:{bottom:0,textStyle:{color:TX}},
    grid:{top:20,bottom:50,left:50,right:30},
    xAxis:{type:'category',data:labels,axisLine:{lineStyle:{color:LN}},axisLabel:{color:TX,fontSize:11}},
    yAxis:{type:'value',name:'秒',nameTextStyle:{color:TX},axisLabel:{color:TX},splitLine:{lineStyle:{color:LN}}},
    series:[
      {name:BOT1_SHORT+'('+BOT1_MODEL+')',type:'line',data:d1,lineStyle:{color:C1,width:3},itemStyle:{color:C1},symbol:'circle',symbolSize:10,
        label:{show:true,formatter:'{c}s',color:C1,fontSize:12,fontWeight:600,position:'top'},areaStyle:{color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(8,145,178,0.15)'},{offset:1,color:'rgba(8,145,178,0)'}])}},
      {name:BOT2_SHORT+'('+BOT2_MODEL+')',type:'line',data:d2,lineStyle:{color:C2,width:3},itemStyle:{color:C2},symbol:'circle',symbolSize:10,
        label:{show:true,formatter:'{c}s',color:C2,fontSize:12,fontWeight:600,position:'bottom'},areaStyle:{color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(124,58,237,0.15)'},{offset:1,color:'rgba(124,58,237,0)'}])}},
    ]
  });
}

function renderTrendCategoryChart(){
  var c=initChart('chart-trend-category');
  if(!c)return;
  var cats=[...new Set(ROUNDS[0].bot1.results.map(r=>r.category))].sort();
  function catRate(bot,cat){
    var items=bot.results.filter(r=>r.category===cat);
    if(!items.length)return 0;
    var ok=items.filter(r=>!FAIL_REASONS.includes(r.reason)).length;
    return +(ok/items.length*100).toFixed(1);
  }
  var series=[];
  ROUNDS.forEach(function(r,i){
    series.push({
      name:r.label+' '+BOT1_SHORT,type:'bar',
      data:cats.map(function(cat){return catRate(r.bot1,cat)}),
      itemStyle:{color:i===0?C1:i===1?'#06B6D4':'#67E8F9',borderRadius:[0,4,4,0]},
      label:{show:ROUNDS.length<=2,position:'right',formatter:'{c}%',fontSize:10,color:C1}
    });
    series.push({
      name:r.label+' '+BOT2_SHORT,type:'bar',
      data:cats.map(function(cat){return catRate(r.bot2,cat)}),
      itemStyle:{color:i===0?C2:i===1?'#8B5CF6':'#C4B5FD',borderRadius:[0,4,4,0]},
      label:{show:ROUNDS.length<=2,position:'right',formatter:'{c}%',fontSize:10,color:C2}
    });
  });
  c.setOption({
    tooltip:{trigger:'axis',...tipStyle()},
    legend:{bottom:0,textStyle:{color:TX,fontSize:11},type:'scroll'},
    grid:{left:80,top:10,bottom:60,right:30},
    yAxis:{type:'category',data:cats,axisLine:{lineStyle:{color:LN}},axisLabel:{color:TX}},
    xAxis:{type:'value',max:100,axisLabel:{formatter:'{value}%',color:TX},splitLine:{lineStyle:{color:LN}}},
    series:series
  });
}

function renderStatusChanges(){
  var el=document.getElementById('status-changes');
  if(ROUNDS.length<2){el.innerHTML='<p style="color:var(--text-dim);font-size:13px;padding:8px">2回以上のテストが必要です。</p>';return}
  var changes=[];
  var first=ROUNDS[0],last=ROUNDS[ROUNDS.length-1];
  for(var i=0;i<first.bot1.results.length;i++){
    var fb1=isRagFail(first.bot1.results[i]),fb2=isRagFail(first.bot2.results[i]);
    var lb1=isRagFail(last.bot1.results[i]),lb2=isRagFail(last.bot2.results[i]);
    // Track bot1 changes
    if(fb1!==lb1||fb2!==lb2){
      changes.push({
        index:first.bot1.results[i].index,
        category:first.bot1.results[i].category,
        question:first.bot1.results[i].question,
        b1_first:first.bot1.results[i].reason,b1_last:last.bot1.results[i].reason,
        b2_first:first.bot2.results[i].reason,b2_last:last.bot2.results[i].reason,
        b1_changed:fb1!==lb1,b2_changed:fb2!==lb2,
        b1_improved:fb1&&!lb1,b1_regressed:!fb1&&lb1,
        b2_improved:fb2&&!lb2,b2_regressed:!fb2&&lb2
      });
    }
  }
  if(!changes.length){el.innerHTML='<p style="color:var(--text-dim);font-size:13px;padding:8px">'+first.label+'と'+last.label+'の間でステータスが変化した質問はありません。</p>';return}
  var html='<p style="font-size:12px;color:var(--text-dim);margin-bottom:12px">'+first.label+'→'+last.label+'の間でステータスが変化した質問: <b>'+changes.length+'件</b></p>';
  html+='<table class="status-change-table"><thead><tr><th>#</th><th>カテゴリ</th><th>質問</th><th>'+BOT1_SHORT+'<br>'+first.label+'→'+last.label+'</th><th>'+BOT2_SHORT+'<br>'+first.label+'→'+last.label+'</th></tr></thead><tbody>';
  changes.forEach(function(c){
    var b1cls=c.b1_improved?'sc-improved':c.b1_regressed?'sc-regressed':'';
    var b2cls=c.b2_improved?'sc-improved':c.b2_regressed?'sc-regressed':'';
    html+='<tr><td>'+c.index+'</td><td><span class="badge-cat">'+c.category+'</span></td><td style="max-width:300px;color:var(--text)">'+escHtml(c.question)+'</td>';
    html+='<td class="'+b1cls+'">'+c.b1_first+' → '+c.b1_last+'</td>';
    html+='<td class="'+b2cls+'">'+c.b2_first+' → '+c.b2_last+'</td></tr>';
  });
  html+='</tbody></table>';
  el.innerHTML=html;
}

// ============================================================
// BOOTSTRAP
// ============================================================
(async function(){
  var ok=await loadData();
  if(!ok){
    document.querySelector('.container').innerHTML=
      '<div style="display:flex;align-items:center;justify-content:center;min-height:50vh;text-align:center"><div>'+
      '<div style="font-size:40px;margin-bottom:16px">&#x26A0;</div>'+
      '<h2 style="font-size:18px;color:var(--text);margin-bottom:8px">データファイルが見つかりません</h2>'+
      '<p style="font-size:13px;color:var(--text-dim)">HTMLファイルと同じフォルダに eval-*.json ファイルを配置してください。</p>'+
      '</div></div>';
    return;
  }
  init();
})();

window.addEventListener('resize',function(){chartInstances.forEach(function(c){try{c.resize()}catch(e){}})});
</script>
</body>
</html>
