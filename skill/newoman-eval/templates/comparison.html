<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEWoMan高輪 Bot 比較レポート</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap');

/* ========== Light Analytics Theme ========== */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#F5F7FA;--bg-card:#FFFFFF;--bg-card-hover:#FAFBFC;--bg-elevated:#F0F2F5;
  --border:#E2E8F0;--border-light:#CBD5E1;
  --text:#1A202C;--text-muted:#4A5568;--text-dim:#718096;
  --cyan:#0891B2;--cyan-dim:rgba(8,145,178,0.08);--cyan-glow:rgba(8,145,178,0.18);
  --purple:#7C3AED;--purple-dim:rgba(124,58,237,0.08);--purple-glow:rgba(124,58,237,0.18);
  --green:#059669;--green-dim:rgba(5,150,105,0.08);
  --red:#E11D48;--red-dim:rgba(225,29,72,0.08);
  --orange:#D97706;--orange-dim:rgba(217,119,6,0.08);
  --radius:12px;--radius-lg:16px;
}
body{font-family:'Inter','Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;-webkit-font-smoothing:antialiased}
.container{max-width:1280px;margin:0 auto;padding:32px 20px}
@media(min-width:768px){.container{padding:40px 32px}}

/* Cards */
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;transition:border-color .2s,box-shadow .2s;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
.card:hover{border-color:var(--border-light);box-shadow:0 2px 8px rgba(0,0,0,0.06)}
.card-title{font-size:14px;font-weight:600;color:var(--text-muted);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.card-title svg{width:16px;height:16px;opacity:.5}

/* Header */
.header{margin-bottom:32px}
.header h1{font-size:24px;font-weight:700;letter-spacing:-.02em;margin-bottom:6px}
@media(min-width:768px){.header h1{font-size:28px}}
.header .subtitle{font-size:13px;color:var(--text-dim);margin-bottom:24px}

/* Bot identity cards */
.bot-cards{display:grid;grid-template-columns:1fr;gap:16px;margin-bottom:32px}
@media(min-width:768px){.bot-cards{grid-template-columns:1fr 1fr}}
.bot-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px 24px;position:relative;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
.bot-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.bot-card.bot1::before{background:linear-gradient(90deg,var(--cyan),transparent)}
.bot-card.bot2::before{background:linear-gradient(90deg,var(--purple),transparent)}
.bot-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.bot-label .dot{width:8px;height:8px;border-radius:50%}
.bot1 .bot-label{color:var(--cyan)}.bot1 .dot{background:var(--cyan);box-shadow:0 0 6px var(--cyan-glow)}
.bot2 .bot-label{color:var(--purple)}.bot2 .dot{background:var(--purple);box-shadow:0 0 6px var(--purple-glow)}
.bot-name{font-size:18px;font-weight:700;margin-bottom:8px}
.bot-model-tag{display:inline-block;padding:4px 14px;border-radius:6px;font-size:14px;font-weight:700;letter-spacing:.3px}
.bot1 .bot-model-tag{background:var(--cyan-dim);color:var(--cyan);border:1px solid rgba(8,145,178,0.2)}
.bot2 .bot-model-tag{background:var(--purple-dim);color:var(--purple);border:1px solid rgba(124,58,237,0.2)}
.bot-id{font-family:'SF Mono','Fira Code','Consolas',monospace;font-size:11px;color:var(--text-dim);letter-spacing:.3px;margin-top:8px}

/* Summary box */
.summary-box{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px 28px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
.summary-box .summary-title{font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.summary-box .summary-text{font-size:14px;line-height:1.8;color:var(--text-muted)}
.summary-box .summary-text b{color:var(--text);font-weight:600}
.summary-box .highlight-good{color:var(--green);font-weight:700}
.summary-box .highlight-warn{color:var(--orange);font-weight:700}
.summary-box .highlight-bad{color:var(--red);font-weight:700}
.summary-section{margin-bottom:16px;padding:14px 18px;border-radius:10px;background:var(--bg);border:1px solid var(--border)}
.summary-section:last-child{margin-bottom:0}
.summary-section-head{font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px;display:flex;align-items:center;gap:6px}
.summary-section-head .sec-icon{width:20px;height:20px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;color:#fff;flex-shrink:0}
.summary-section-body{font-size:13px;line-height:1.9;color:var(--text-muted)}
.summary-section-body b{color:var(--text);font-weight:600}
.summary-stat{display:inline-flex;align-items:center;gap:4px;padding:2px 10px;border-radius:5px;font-size:12px;font-weight:700;margin:0 2px}
.stat-cyan{background:var(--cyan-dim);color:var(--cyan)}
.stat-purple{background:var(--purple-dim);color:var(--purple)}
.stat-green{background:var(--green-dim);color:var(--green)}
.stat-orange{background:var(--orange-dim);color:var(--orange)}

/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:28px}
@media(min-width:768px){.kpi-grid{grid-template-columns:repeat(3,1fr);gap:16px}}
@media(min-width:1024px){.kpi-grid{grid-template-columns:repeat(6,1fr);gap:16px}}
.kpi{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
.kpi-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:8px}
.kpi-value{font-size:28px;font-weight:800;letter-spacing:-.02em;line-height:1.1}
@media(min-width:768px){.kpi-value{font-size:34px}}
.kpi-sub{font-size:12px;color:var(--text-dim);margin-top:4px}
.kpi-cyan .kpi-value{color:var(--cyan)}
.kpi-purple .kpi-value{color:var(--purple)}
.kpi-green .kpi-value{color:var(--green)}
.kpi-orange .kpi-value{color:var(--orange)}
.kpi-red .kpi-value{color:var(--red)}

/* Grid layouts */
.grid-2{display:grid;grid-template-columns:1fr;gap:16px;margin-bottom:16px}
@media(min-width:768px){.grid-2{grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}}

/* Charts */
.chart-box{width:100%;height:300px}
.chart-box-lg{width:100%;height:360px}

/* Table */
.glass-table{width:100%;border-collapse:collapse;font-size:13px}
.glass-table th{padding:10px 14px;text-align:left;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-dim);border-bottom:1px solid var(--border);background:var(--bg-elevated)}
.glass-table td{padding:10px 14px;border-bottom:1px solid var(--border);color:var(--text-muted)}
.glass-table tr:hover td{background:rgba(0,0,0,.02)}
.glass-table td:first-child{color:var(--text-dim);font-family:'SF Mono',monospace;font-size:12px}

/* Badges */
.badge{display:inline-block;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:600;letter-spacing:.2px}
.badge-answered{background:var(--green-dim);color:var(--green)}
.badge-unanswered{background:var(--red-dim);color:var(--red)}
.badge-cat{background:var(--bg-elevated);color:var(--text-dim);border-radius:4px;font-size:11px;padding:2px 8px}
.winner-cell{background:rgba(5,150,105,.06)}

/* Tabs */
.tabs{display:flex;gap:2px;margin-bottom:20px;border-bottom:1px solid var(--border)}
.tab{padding:10px 18px;cursor:pointer;font-size:13px;font-weight:500;color:var(--text-dim);border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .2s}
.tab:hover{color:var(--text-muted)}
.tab.active{color:var(--cyan);border-bottom-color:var(--cyan)}
.tab-content{display:none}.tab-content.active{display:block}

/* Filter */
.filter-row{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
.filter-row label{font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px}
.filter-row select,.filter-row input{padding:7px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:var(--bg-elevated);color:var(--text);outline:none;transition:border-color .2s;font-family:inherit}
.filter-row select:focus,.filter-row input:focus{border-color:var(--cyan)}
.filter-row select option{background:var(--bg-card)}
.filter-row input{width:200px}
.filter-row input::placeholder{color:var(--text-dim)}

/* Answer preview */
.answer-preview{max-height:150px;overflow-y:auto;font-size:12px;line-height:1.7;color:var(--text-muted);background:var(--bg);padding:12px 14px;border-radius:8px;margin-top:6px;white-space:pre-wrap;word-break:break-all;border:1px solid var(--border)}
.answer-preview::-webkit-scrollbar{width:4px}
.answer-preview::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:4px}
.answer-toggle{cursor:pointer;color:var(--cyan);font-size:12px;font-weight:500;transition:opacity .2s}
.answer-toggle:hover{opacity:.7}

/* Footer */
.footer{text-align:center;padding:24px 0 16px;font-size:11px;color:var(--text-dim)}

/* Scrollbar */
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px}

/* Animations */
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.animate-in{animation:fadeUp .4s ease both}
.animate-in:nth-child(1){animation-delay:0s}
.animate-in:nth-child(2){animation-delay:.06s}
.animate-in:nth-child(3){animation-delay:.12s}
.animate-in:nth-child(4){animation-delay:.18s}

/* Reduced motion */
@media(prefers-reduced-motion:reduce){.animate-in{animation:none}}
</style>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
<div class="container">

  <!-- ===== HEADER ===== -->
  <div class="header">
    <h1>NEWoMan高輪 Bot 比較レポート</h1>
    <p class="subtitle" id="report-subtitle"></p>
  </div>

  <!-- ===== BOT IDENTITY ===== -->
  <div class="bot-cards">
    <div class="bot-card bot1 animate-in">
      <div class="bot-label"><span class="dot"></span>Bot 1 &mdash; 検証環境</div>
      <div class="bot-name">NEWoMan高輪 検証環境</div>
      <div class="bot-model-tag">Claude Sonnet 4.5</div>
      <div class="bot-id">ID: fa228b57-59e1-447b-87e2-02c494195961</div>
    </div>
    <div class="bot-card bot2 animate-in">
      <div class="bot-label"><span class="dot"></span>Bot 2 &mdash; 本番環境</div>
      <div class="bot-name">NEWoMan高輪 本番環境</div>
      <div class="bot-model-tag">Gemini 2.5 Flash</div>
      <div class="bot-id">ID: b50d5b21-262a-4802-a8c4-512af224c72f</div>
    </div>
  </div>

  <!-- ===== EXECUTIVE SUMMARY ===== -->
  <div class="summary-box animate-in" id="exec-summary"></div>

  <!-- ===== RAG EXECUTION ANALYSIS ===== -->
  <div class="card" style="margin-bottom:20px">
    <div class="card-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/></svg>
      回答処理の分析
    </div>
    <p style="font-size:12px;color:var(--text-dim);margin:-8px 0 16px;line-height:1.6">
      <b style="color:var(--green)">正常処理</b> = 回答を返した + 該当情報なし&emsp;
      <b style="color:var(--red)">処理失敗</b> = 応答なし + 定型文のみ + エラー
    </p>
    <div class="kpi-grid" id="rag-kpi-row" style="margin-bottom:20px"></div>
    <div class="grid-2" style="margin-bottom:0">
      <div><div class="chart-box" id="chart-rag-exec"></div></div>
      <div><div class="chart-box" id="chart-rag-fail-detail"></div></div>
    </div>
  </div>

  <!-- ===== CHARTS ROW 1 ===== -->
  <div class="grid-2">
    <div class="card">
      <div class="card-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        カテゴリ別の正常回答率
      </div>
      <div class="chart-box-lg" id="chart-category"></div>
    </div>
    <div class="card">
      <div class="card-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 1 0 20"/><path d="M2 12h20"/></svg>
        回答ソースの内訳 (RAG / FAQ)
      </div>
      <div class="chart-box-lg" id="chart-source"></div>
    </div>
  </div>


  <!-- ===== RESPONSE TIME ===== -->
  <div class="card" style="margin-bottom:20px">
    <div class="card-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      平均応答時間（秒）
    </div>
    <div class="kpi-grid" id="time-kpi-row" style="margin-bottom:20px;grid-template-columns:repeat(3,1fr)"></div>
    <div class="chart-box" id="chart-time"></div>
  </div>

  <!-- ===== DATA TABLE ===== -->
  <div class="card" style="margin-bottom:20px">
    <div class="card-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
      全質問の一覧 (<span id="visible-count">300</span> / 300)
    </div>

    <div class="filter-row">
      <label>カテゴリ:</label>
      <select id="filter-cat"><option value="">すべて</option></select>
      <label>処理結果:</label>
      <select id="filter-result">
        <option value="">すべて</option>
        <option value="both-ok">両方とも正常</option>
        <option value="both-fail">両方とも失敗</option>
        <option value="bot1-ok-only">検証のみ正常</option>
        <option value="bot2-ok-only">本番のみ正常</option>
        <option value="any-fail">失敗あり</option>
      </select>
      <label>検索:</label>
      <input type="text" id="filter-search" placeholder="質問を検索...">
    </div>

    <div style="overflow-x:auto">
      <table class="glass-table">
        <thead><tr>
          <th>#</th><th>カテゴリ</th><th>質問</th>
          <th>検証環境<br><span style="font-weight:400;opacity:.6">Sonnet 4.5</span></th>
          <th>本番環境<br><span style="font-weight:400;opacity:.6">Gemini 2.5 Flash</span></th>
          <th>詳細</th>
        </tr></thead>
        <tbody id="tbody-all"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">Generated by newoman-eval</div>
</div>

<script>
const BOT1_SHORT='検証環境',BOT2_SHORT='本番環境';
const BOT1_MODEL='Sonnet 4.5',BOT2_MODEL='Gemini 2.5 Flash';
const C1='#0891B2',C1L='#22D3EE',C2='#7C3AED',C2L='#A78BFA';
const TX='#718096',LN='#E2E8F0';

let BOT1=null,BOT2=null;

async function loadData(){
  try{
    const[r1,r2]=await Promise.all([
      fetch('eval-fa228b57-20260220-182201.json'),
      fetch('eval-b50d5b21-20260220-212710.json')
    ]);
    if(r1.ok&&r2.ok){BOT1=await r1.json();BOT2=await r2.json();return true}
  }catch(e){}
  return false;
}

function init(){
  const b1=BOT1,b2=BOT2,s1=b1.summary,s2=b2.summary;

  document.getElementById('report-subtitle').textContent=
    `テスト日: ${b1.meta.timestamp.slice(0,10)} \u2502 質問数: ${b1.meta.total_questions}`;

  renderSummary(b1,b2);
  renderRagAnalysis(b1,b2);
  renderCategoryChart(b1,b2);renderSourceChart(s1,s2);renderTimeChart(b1,b2);
  renderTable(b1,b2);

  // Filters
  const cats=[...new Set(b1.results.map(r=>r.category))].sort();
  const cs=document.getElementById('filter-cat');
  cats.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;cs.appendChild(o)});
  ['filter-cat','filter-result','filter-search'].forEach(id=>{
    document.getElementById(id).addEventListener(id==='filter-search'?'input':'change',()=>applyFilters(b1,b2));
  });
}

// --- Executive summary ---
function renderSummary(b1,b2){
  const FAIL=['empty','filler_only','error'];
  function calc(bot){
    const t=bot.results.length;
    const f=bot.results.filter(r=>FAIL.includes(r.reason)).length;
    const nf=bot.results.filter(r=>r.reason==='not_found').length;
    const ans=bot.results.filter(r=>r.reason==='answered').length;
    return{total:t,ok:t-f,fail:f,rate:+((t-f)/t*100).toFixed(1),answered:ans,not_found:nf,
      empty:bot.results.filter(r=>r.reason==='empty').length,
      filler:bot.results.filter(r=>r.reason==='filler_only').length,
      error:bot.results.filter(r=>r.reason==='error').length};
  }
  const r1=calc(b1),r2=calc(b2);
  function avgTime(results){return+(results.reduce((s,r)=>s+r.elapsed_seconds,0)/results.length).toFixed(1)}
  const t1=avgTime(b1.results),t2=avgTime(b2.results);
  // Max category-average time (matches the category response time chart)
  function maxCatAvg(bot){
    const cats={};
    bot.results.forEach(r=>{if(!cats[r.category])cats[r.category]=[];cats[r.category].push(r.elapsed_seconds)});
    let mx=0;
    for(const c in cats){const a=+(cats[c].reduce((s,v)=>s+v,0)/cats[c].length).toFixed(1);if(a>mx)mx=a}
    return mx;
  }
  const catMax1=maxCatAvg(b1),catMax2=maxCatAvg(b2);
  // FAQ/RAG separate times
  const faq1=b1.results.filter(r=>r.source==='faq'),faq2=b2.results.filter(r=>r.source==='faq');
  const rag1=b1.results.filter(r=>r.source==='rag'),rag2=b2.results.filter(r=>r.source==='rag');
  const faqAvg1=faq1.length?+(faq1.reduce((s,r)=>s+r.elapsed_seconds,0)/faq1.length).toFixed(1):0;
  const faqAvg2=faq2.length?+(faq2.reduce((s,r)=>s+r.elapsed_seconds,0)/faq2.length).toFixed(1):0;
  const ragAvg1=rag1.length?+(rag1.reduce((s,r)=>s+r.elapsed_seconds,0)/rag1.length).toFixed(1):0;
  const ragAvg2=rag2.length?+(rag2.reduce((s,r)=>s+r.elapsed_seconds,0)/rag2.length).toFixed(1):0;
  const testDate=b1.meta.timestamp.slice(0,10);

  const el=document.getElementById('exec-summary');
  el.innerHTML=`
    <div class="summary-title">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></svg>
      テスト結果の概要
    </div>

    <div class="summary-section">
      <div class="summary-section-head">
        <span class="sec-icon" style="background:#64748B">1</span>
        テストの概要
      </div>
      <div class="summary-section-body">
        ${testDate} に、NEWoMan高輪チャットボットの<b>モデル切り替え検証</b>として、
        <span class="summary-stat stat-cyan">${BOT1_SHORT}（${BOT1_MODEL}）</span>と
        <span class="summary-stat stat-purple">${BOT2_SHORT}（${BOT2_MODEL}）</span>の2つの環境に対し、
        同一の <b>${b1.meta.total_questions}件</b> のテスト質問を送信して比較しました。
        テスト質問は営業時間・アクセス・店舗情報・イベント・施設案内など実際のユーザーが聞く内容を網羅しています。
        <br>本テストの目的は、<b>モデルを ${BOT2_MODEL} から ${BOT1_MODEL} に変更した場合、RAG処理の安定性がどの程度向上するか</b>を検証することです。
      </div>
    </div>

    <div class="summary-section">
      <div class="summary-section-head">
        <span class="sec-icon" style="background:var(--green)">2</span>
        回答の安定性 &mdash; ${BOT1_MODEL} が大幅に改善
      </div>
      <div class="summary-section-body">
        RAGパイプライン（情報検索→回答生成）が<b>正常に完了した割合</b>を比較すると、
        <span class="summary-stat stat-cyan">${BOT1_MODEL}: ${r1.rate}%</span>に対し
        <span class="summary-stat stat-purple">${BOT2_MODEL}: ${r2.rate}%</span>です。<br>
        <b>${BOT1_MODEL}</b> は処理失敗（応答なし・定型文のみ・エラー）が
        <span class="summary-stat stat-green">${r1.fail}件</span>と${r1.fail===0?'<b>ゼロ</b>であり':'極めて少なく'}、
        全${r1.total}件すべてでRAG処理が正常に完了しました。
        一方、<b>${BOT2_MODEL}</b> は処理失敗が
        <span class="summary-stat stat-orange">${r2.fail}件</span>
        ${r2.filler>0?`（定型文のみ: ${r2.filler}件）`:''} 発生しています。<br>
        また、回答を返せた件数も <b>${BOT1_MODEL}: ${r1.answered}件</b> vs <b>${BOT2_MODEL}: ${r2.answered}件</b> と
        <b>${r1.answered-r2.answered}件の差</b>があり、
        ${BOT1_MODEL} はより多くの質問に対して有効な情報を検索・回答できています。
        <br><b>結論：${BOT1_MODEL} への切り替えにより、RAG処理の安定性は明確に向上しています。</b>
      </div>
    </div>

    <div class="summary-section">
      <div class="summary-section-head">
        <span class="sec-icon" style="background:var(--cyan)">3</span>
        応答速度 &mdash; 体感上の差はほぼなし
      </div>
      <div class="summary-section-body">
        全体の平均応答時間は
        <span class="summary-stat stat-cyan">${BOT1_MODEL}: ${t1}秒</span>
        <span class="summary-stat stat-purple">${BOT2_MODEL}: ${t2}秒</span>
        で、${BOT1_MODEL} が約 <b>${Math.abs(t1-t2).toFixed(1)}秒</b> 遅い結果です。
        ただし、この数値はバックエンドの<b>RAG情報検索を含むエンドツーエンドの処理時間</b>です。<br>
        実際の利用シーンでは、FAQ（よくある質問）経由の回答は
        <b>${BOT1_MODEL}: 平均${faqAvg1}秒</b> / <b>${BOT2_MODEL}: 平均${faqAvg2}秒</b> と
        いずれも <b>1秒未満</b> で即答されるため、ユーザー体験への影響はありません。<br>
        さらに、カテゴリ別の<b>最大平均応答時間</b>を見ると
        <span class="summary-stat stat-cyan">${BOT1_MODEL}: ${catMax1}秒</span>に対し
        <span class="summary-stat stat-purple">${BOT2_MODEL}: ${catMax2}秒</span>と、
        ${BOT2_MODEL} の方が<b>${(catMax2-catMax1).toFixed(1)}秒遅く</b>、${BOT1_MODEL} の方がむしろ安定しています。
        <br><b>結論：全体平均では約${Math.abs(t1-t2).toFixed(0)}秒の差がありますが、FAQ即答・カテゴリ別ピークの安定性を考慮すると、${BOT1_MODEL} がユーザー体験上不利になることはありません。</b>
      </div>
    </div>`;
}

// --- Chart helpers ---
function tipStyle(){return{backgroundColor:'#FFFFFF',borderColor:'#E2E8F0',textStyle:{color:'#1A202C',fontSize:12},extraCssText:'box-shadow:0 4px 12px rgba(0,0,0,0.1)'}}
function barGrad(c1,c2){return new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:c1},{offset:1,color:c2}])}

function renderRagAnalysis(b1,b2){
  const FAIL_REASONS=['empty','filler_only','error'];
  function calc(bot){
    const total=bot.results.length;
    const fail=bot.results.filter(r=>FAIL_REASONS.includes(r.reason)).length;
    const ok=total-fail;
    const empty=bot.results.filter(r=>r.reason==='empty').length;
    const filler=bot.results.filter(r=>r.reason==='filler_only').length;
    const err=bot.results.filter(r=>r.reason==='error').length;
    return {total,ok,fail,rate:+(ok/total*100).toFixed(1),empty,filler,err};
  }
  const r1=calc(b1),r2=calc(b2);
  const diff=(r1.rate-r2.rate).toFixed(1);
  function avgAll(results){return+(results.reduce((s,r)=>s+r.elapsed_seconds,0)/results.length).toFixed(1)}
  const t1=avgAll(b1.results),t2=avgAll(b2.results);

  // KPI
  const kpiRow=document.getElementById('rag-kpi-row');
  const kpis=[
    {label:`${BOT1_SHORT} 正常回答率`,value:`${r1.rate}%`,sub:`${r1.ok} / ${r1.total} 正常`,cls:'kpi-cyan'},
    {label:`${BOT2_SHORT} 正常回答率`,value:`${r2.rate}%`,sub:`${r2.ok} / ${r2.total} 正常`,cls:'kpi-purple'},
    {label:'回答率の差',value:`${diff>0?'+':''}${diff}%`,sub:'検証 − 本番',cls:parseFloat(diff)>=0?'kpi-green':'kpi-red'},
    {label:'失敗数の差',value:Math.abs(r1.fail-r2.fail),sub:`検証${r1.fail}件 / 本番${r2.fail}件`,cls:'kpi-orange'},
    {label:`${BOT1_SHORT} 平均応答`,value:`${t1}s`,sub:'全質問平均',cls:'kpi-cyan'},
    {label:`${BOT2_SHORT} 平均応答`,value:`${t2}s`,sub:'全質問平均',cls:'kpi-purple'},
  ];
  kpiRow.innerHTML=kpis.map((k,i)=>`
    <div class="kpi ${k.cls} animate-in" style="animation-delay:${i*.06}s">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-value">${k.value}</div>
      <div class="kpi-sub">${k.sub}</div>
    </div>`).join('');

  // Stacked bar: OK vs Fail
  const c1=echarts.init(document.getElementById('chart-rag-exec'));
  c1.setOption({
    tooltip:{trigger:'axis',...tipStyle(),formatter:p=>{
      let s=p[0].axisValue+'<br>';
      p.forEach(x=>s+=`<span style="color:${x.color}">\u25CF</span> ${x.seriesName}: ${x.value}件<br>`);
      return s;
    }},
    legend:{bottom:0,textStyle:{color:TX}},
    grid:{top:30,bottom:50,left:50,right:20},
    xAxis:{type:'category',data:[`${BOT1_SHORT}\n(${BOT1_MODEL})`,`${BOT2_SHORT}\n(${BOT2_MODEL})`],axisLine:{lineStyle:{color:LN}},axisLabel:{color:TX,fontWeight:600}},
    yAxis:{type:'value',max:r1.total,splitLine:{lineStyle:{color:LN}},axisLabel:{color:TX}},
    series:[
      {name:'正常処理',type:'bar',stack:'a',data:[r1.ok,r2.ok],itemStyle:{color:'#059669',borderRadius:[0,0,0,0]},barWidth:'40%',
        label:{show:true,position:'inside',color:'#fff',fontWeight:600,fontSize:13}},
      {name:'処理失敗',type:'bar',stack:'a',data:[r1.fail,r2.fail],itemStyle:{color:'#E11D48',borderRadius:[6,6,0,0]},barWidth:'40%',
        label:{show:true,position:'inside',color:'#fff',fontWeight:600,fontSize:13,formatter:p=>p.value>0?p.value:''}},
    ]
  });
  window.addEventListener('resize',()=>c1.resize());

  // Fail detail breakdown
  const c2=echarts.init(document.getElementById('chart-rag-fail-detail'));
  c2.setOption({
    tooltip:{trigger:'axis',...tipStyle()},
    legend:{bottom:0,textStyle:{color:TX}},
    grid:{top:30,bottom:50,left:50,right:20},
    xAxis:{type:'category',data:['応答なし','定型文のみ','エラー'],axisLine:{lineStyle:{color:LN}},axisLabel:{color:TX}},
    yAxis:{type:'value',splitLine:{lineStyle:{color:LN}},axisLabel:{color:TX}},
    series:[
      {name:`${BOT1_SHORT}(${BOT1_MODEL})`,type:'bar',data:[r1.empty,r1.filler,r1.err],itemStyle:{color:barGrad(C1,C1L),borderRadius:[6,6,0,0]},barWidth:'26%',
        label:{show:true,position:'top',color:C1,fontWeight:600}},
      {name:`${BOT2_SHORT}(${BOT2_MODEL})`,type:'bar',data:[r2.empty,r2.filler,r2.err],itemStyle:{color:barGrad(C2,C2L),borderRadius:[6,6,0,0]},barWidth:'26%',
        label:{show:true,position:'top',color:C2,fontWeight:600}},
    ]
  });
  window.addEventListener('resize',()=>c2.resize());
}

function renderCategoryChart(b1,b2){
  const c=echarts.init(document.getElementById('chart-category'));
  const FAIL=['empty','filler_only','error'];
  const cats=[...new Set(b1.results.map(r=>r.category))].sort();
  function ragRate(results,cat){
    const items=results.filter(r=>r.category===cat);
    if(!items.length)return 0;
    const ok=items.filter(r=>!FAIL.includes(r.reason)).length;
    return +(ok/items.length*100).toFixed(1);
  }
  c.setOption({
    tooltip:{trigger:'axis',...tipStyle(),formatter:p=>p.map(x=>`<span style="color:${x.color}">\u25CF</span> ${x.seriesName}: ${x.value}%`).join('<br>')},
    legend:{bottom:0,textStyle:{color:TX}},
    grid:{left:80,top:10,bottom:50,right:60},
    yAxis:{type:'category',data:cats,axisLine:{lineStyle:{color:LN}},axisLabel:{color:TX}},
    xAxis:{type:'value',max:100,axisLabel:{formatter:'{value}%',color:TX},splitLine:{lineStyle:{color:LN}}},
    series:[
      {name:`${BOT1_SHORT}(${BOT1_MODEL})`,type:'bar',data:cats.map(c=>ragRate(b1.results,c)),itemStyle:{color:C1,borderRadius:[0,4,4,0]},label:{show:true,position:'right',formatter:'{c}%',color:C1,fontSize:11}},
      {name:`${BOT2_SHORT}(${BOT2_MODEL})`,type:'bar',data:cats.map(c=>ragRate(b2.results,c)),itemStyle:{color:C2,borderRadius:[0,4,4,0]},label:{show:true,position:'right',formatter:'{c}%',color:C2,fontSize:11}},
    ]
  });
  window.addEventListener('resize',()=>c.resize());
}

function renderSourceChart(s1,s2){
  const c=echarts.init(document.getElementById('chart-source'));
  const ss1=s1.source_stats||{},ss2=s2.source_stats||{};
  c.setOption({
    tooltip:{trigger:'item',...tipStyle()},
    series:[
      {name:`${BOT1_SHORT}(${BOT1_MODEL})`,type:'pie',radius:['30%','52%'],center:['28%','55%'],
        data:[{name:'RAG',value:ss1.rag||0,itemStyle:{color:C1}},{name:'FAQ',value:ss1.faq||0,itemStyle:{color:C1L}}],
        label:{formatter:'{b}\n{c}件 ({d}%)',color:TX,fontSize:11,lineHeight:16},
        labelLine:{length:12,length2:8},
        emphasis:{itemStyle:{shadowBlur:12,shadowColor:'rgba(8,145,178,0.15)'}}},
      {name:`${BOT2_SHORT}(${BOT2_MODEL})`,type:'pie',radius:['30%','52%'],center:['72%','55%'],
        data:[{name:'RAG',value:ss2.rag||0,itemStyle:{color:C2}},{name:'FAQ',value:ss2.faq||0,itemStyle:{color:C2L}}],
        label:{formatter:'{b}\n{c}件 ({d}%)',color:TX,fontSize:11,lineHeight:16},
        labelLine:{length:12,length2:8},
        emphasis:{itemStyle:{shadowBlur:12,shadowColor:'rgba(124,58,237,0.15)'}}},
    ],
    title:[
      {text:`${BOT1_SHORT}\n(${BOT1_MODEL})`,left:'28%',top:'8%',textStyle:{fontSize:12,color:C1,fontWeight:600,lineHeight:16},textAlign:'center'},
      {text:`${BOT2_SHORT}\n(${BOT2_MODEL})`,left:'72%',top:'8%',textStyle:{fontSize:12,color:C2,fontWeight:600,lineHeight:16},textAlign:'center'},
    ]
  });
  window.addEventListener('resize',()=>c.resize());
}

function renderTimeChart(b1,b2){
  function avgAll(results){if(!results.length)return 0;return+(results.reduce((s,r)=>s+r.elapsed_seconds,0)/results.length).toFixed(1)}
  const avg1=avgAll(b1.results),avg2=avgAll(b2.results);
  const timeDiff=(avg1-avg2).toFixed(1);
  const tkpi=document.getElementById('time-kpi-row');
  const tkpis=[
    {label:`${BOT1_SHORT} (${BOT1_MODEL})`,value:`${avg1}s`,sub:`${b1.results.length}件の平均`,cls:'kpi-cyan'},
    {label:`${BOT2_SHORT} (${BOT2_MODEL})`,value:`${avg2}s`,sub:`${b2.results.length}件の平均`,cls:'kpi-purple'},
    {label:'差分',value:`${timeDiff>0?'+':''}${timeDiff}s`,sub:'検証 − 本番',cls:parseFloat(timeDiff)<=0?'kpi-green':'kpi-red'},
  ];
  tkpi.innerHTML=tkpis.map((k,i)=>`
    <div class="kpi ${k.cls} animate-in" style="animation-delay:${i*.06}s">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-value">${k.value}</div>
      <div class="kpi-sub">${k.sub}</div>
    </div>`).join('');

  const c=echarts.init(document.getElementById('chart-time'));
  const cats=[...new Set(b1.results.map(r=>r.category))].sort();
  function avg(results,cat){const it=results.filter(r=>r.category===cat);if(!it.length)return 0;return+(it.reduce((s,r)=>s+r.elapsed_seconds,0)/it.length).toFixed(1)}
  c.setOption({
    tooltip:{trigger:'axis',...tipStyle()},
    legend:{bottom:0,textStyle:{color:TX}},
    grid:{top:20,bottom:50,left:50,right:20},
    xAxis:{type:'category',data:cats,axisLine:{lineStyle:{color:LN}},axisLabel:{color:TX,fontSize:11}},
    yAxis:{type:'value',name:'秒',nameTextStyle:{color:TX},splitLine:{lineStyle:{color:LN}},axisLabel:{color:TX}},
    series:[
      {name:`${BOT1_SHORT}(${BOT1_MODEL})`,type:'bar',data:cats.map(c=>avg(b1.results,c)),itemStyle:{color:barGrad(C1,C1L),borderRadius:[6,6,0,0]},barWidth:'26%',label:{show:true,position:'top',formatter:'{c}s',color:C1,fontSize:10}},
      {name:`${BOT2_SHORT}(${BOT2_MODEL})`,type:'bar',data:cats.map(c=>avg(b2.results,c)),itemStyle:{color:barGrad(C2,C2L),borderRadius:[6,6,0,0]},barWidth:'26%',label:{show:true,position:'top',formatter:'{c}s',color:C2,fontSize:10}},
    ]
  });
  window.addEventListener('resize',()=>c.resize());
}

// --- Table ---
const RAG_FAIL=['empty','filler_only','error'];
function isRagFail(r){return RAG_FAIL.includes(r.reason)}
function statusBadge(r){
  if(!isRagFail(r)){
    if(r.reason==='not_found') return `<span class="badge badge-answered" style="background:var(--orange-dim);color:var(--orange)">該当なし</span>`;
    const src=r.source==='faq'?' FAQ':'';
    return `<span class="badge badge-answered">回答${src}</span>`;
  }
  const lb={empty:'応答なし',error:'エラー',filler_only:'定型文'};
  return `<span class="badge badge-unanswered">${lb[r.reason]||r.reason}</span>`;
}

function renderTable(b1,b2){
  const rows=[];
  for(let i=0;i<b1.results.length;i++){
    const r1=b1.results[i],r2=b2.results[i];
    const f1=isRagFail(r1),f2=isRagFail(r2);
    rows.push({r1,r2,f1,f2,isDiff:f1!==f2,index:r1.index,category:r1.category,question:r1.question});
  }
  document.getElementById('tbody-all').innerHTML=rows.map(row=>{
    const w1=row.isDiff&&!row.f1?' winner-cell':'';
    const w2=row.isDiff&&!row.f2?' winner-cell':'';
    return `<tr data-cat="${row.category}" data-f1="${row.f1?1:0}" data-f2="${row.f2?1:0}" data-q="${row.question.toLowerCase()}">
      <td>${row.index}</td>
      <td><span class="badge-cat">${row.category}</span></td>
      <td style="max-width:320px;color:var(--text)">${escHtml(row.question)}</td>
      <td class="${w1}">${statusBadge(row.r1)}</td>
      <td class="${w2}">${statusBadge(row.r2)}</td>
      <td><span class="answer-toggle" onclick="toggleAnswer(this,'${row.index-1}')">展開</span></td>
    </tr>
    <tr class="answer-row" id="answer-${row.index-1}" style="display:none">
      <td colspan="6" style="padding:12px 14px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div>
            <div style="font-size:12px;font-weight:600;color:${C1};margin-bottom:4px;display:flex;align-items:center;gap:6px">
              <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:${C1}"></span>${BOT1_SHORT} (${BOT1_MODEL})
            </div>
            <div class="answer-preview">${escHtml(row.r1.answer||'(応答なし)')}</div>
          </div>
          <div>
            <div style="font-size:12px;font-weight:600;color:${C2};margin-bottom:4px;display:flex;align-items:center;gap:6px">
              <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:${C2}"></span>${BOT2_SHORT} (${BOT2_MODEL})
            </div>
            <div class="answer-preview">${escHtml(row.r2.answer||'(応答なし)')}</div>
          </div>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function escHtml(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

function toggleAnswer(el,id){
  const row=document.getElementById('answer-'+id);
  if(!row)return;
  if(row.style.display==='none'){row.style.display='';el.textContent='閉じる'}
  else{row.style.display='none';el.textContent='展開'}
}

function applyFilters(){
  const cat=document.getElementById('filter-cat').value;
  const result=document.getElementById('filter-result').value;
  const search=document.getElementById('filter-search').value.toLowerCase();
  let count=0;
  document.querySelectorAll('#tbody-all tr').forEach(tr=>{
    if(tr.classList.contains('answer-row'))return;
    const trCat=tr.dataset.cat,trQ=tr.dataset.q||'';
    const f1=tr.dataset.f1==='1',f2=tr.dataset.f2==='1';
    let show=true;
    if(cat&&trCat!==cat)show=false;
    if(search&&!trQ.includes(search))show=false;
    if(result){
      if(result==='both-ok'&&(f1||f2))show=false;
      if(result==='both-fail'&&(!f1||!f2))show=false;
      if(result==='bot1-ok-only'&&(f1||!f2))show=false;
      if(result==='bot2-ok-only'&&(!f1||f2))show=false;
      if(result==='any-fail'&&!f1&&!f2)show=false;
    }
    tr.style.display=show?'':'none';
    if(show)count++;
    const ans=tr.nextElementSibling;
    if(ans&&ans.classList.contains('answer-row')&&!show)ans.style.display='none';
  });
  document.getElementById('visible-count').textContent=count;
}

(async function(){
  const ok=await loadData();
  if(!ok){
    document.querySelector('.container').innerHTML=`
      <div style="display:flex;align-items:center;justify-content:center;min-height:50vh;text-align:center">
        <div>
          <div style="font-size:40px;margin-bottom:16px">&#x26A0;</div>
          <h2 style="font-size:18px;color:var(--text);margin-bottom:8px">データファイルが見つかりません</h2>
          <p style="font-size:13px;color:var(--text-dim)">HTMLファイルと同じフォルダに eval-*.json ファイルを配置してください。</p>
        </div>
      </div>`;
    return;
  }
  init();
})();
</script>
</body>
</html>
